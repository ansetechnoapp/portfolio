{
  "title": "How to Enable Hibernation with a Swap File on Ubuntu (and Other Modern Linux Distributions)",
  "description": "A comprehensive guide to setting up hibernation with a swap file on Ubuntu and other modern Linux distributions, offering more flexibility than traditional swap partitions.",
  "pubDate": "2024-07-15T00:00:00.000Z",
  "tags": [
    "Ubuntu",
    "Linux",
    "Hibernation",
    "System Administration",
    "Swap File"
  ],
  "heroImage": "/assets/icone/matt-icons_system-hibernate.svg",
  "author": "Kevin",
  "content": "<h1>How to Enable Hibernation with a Swap File on Ubuntu (and Other Modern Linux Distributions)</h1>\n<p>Hibernation is a powerful feature that allows you to save the complete state of your session (the contents of RAM) to disk and then completely power off your computer. Upon restarting, everything is restored exactly as it was, with no power consumption during the downtime. However, on many recent Linux distributions, hibernation is not enabled by default, especially if you use a swap file instead of a dedicated swap partition. This guide explains, step by step, how to set up hibernation with a swap file, reliably and securely.</p>\n<h2>Why Use a Swap File for Hibernation?</h2>\n<ul>\n<li><strong>More flexible than a swap partition</strong>: you can resize it easily without repartitioning your disk</li>\n<li><strong>Ideal for systems installed without a dedicated swap partition</strong></li>\n<li><strong>Compatible with most modern file systems</strong></li>\n<li><strong>Easier to manage</strong>: can be created, resized, or removed without affecting other partitions</li>\n</ul>\n<h2>Step-by-Step Guide to Configuring Hibernation with a Swap File</h2>\n<h3>1. Check or Create the Swap File</h3>\n<p>First, check if you already have a swap file and its size:</p>\n<pre><code class=\"language-bash\">sudo swapon --show\n</code></pre>\n<p>If you need to turn off an existing swap file (to resize it, for example):</p>\n<pre><code class=\"language-bash\">sudo swapoff /swap.img\n</code></pre>\n<p>Create or resize the swap file. It should be at least as large as your installed RAM:</p>\n<pre><code class=\"language-bash\"># Example: Creating a 16GB swap file\nsudo fallocate -l 16G /swap.img\nsudo chmod 600 /swap.img\nsudo mkswap /swap.img\nsudo swapon /swap.img\n</code></pre>\n<p>Make it permanent by adding it to <code>/etc/fstab</code>:</p>\n<pre><code class=\"language-bash\"># Add this line to /etc/fstab\n/swap.img none swap sw 0 0\n</code></pre>\n<h3>2. Get the Partition UUID and Swap Offset</h3>\n<p>Get the UUID of the partition containing the swap file:</p>\n<pre><code class=\"language-bash\">sudo findmnt -no UUID -T /swap.img\n</code></pre>\n<p>Find the physical offset of the swap file (crucial for hibernation):</p>\n<pre><code class=\"language-bash\">sudo filefrag -v /swap.img | awk &#39;$1==&quot;0:&quot; { print $4 }&#39;\n</code></pre>\n<p>The output will be something like <code>0:</code> followed by numbers. Note the number after the colon and before the period (e.g., <code>32768</code>).</p>\n<h3>3. Configure GRUB for Hibernation</h3>\n<p>Edit the GRUB configuration file:</p>\n<pre><code class=\"language-bash\">sudo nano /etc/default/grub\n</code></pre>\n<p>Add the resume parameters to <code>GRUB_CMDLINE_LINUX_DEFAULT</code> (replace with your values):</p>\n<pre><code class=\"language-bash\">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash resume=UUID=YOUR_UUID resume_offset=YOUR_OFFSET&quot;\n</code></pre>\n<p>Update GRUB and the initramfs:</p>\n<pre><code class=\"language-bash\">sudo update-grub\nsudo update-initramfs -u\n</code></pre>\n<h3>4. Allow Hibernation for All Users</h3>\n<p>Create the PolicyKit file to allow hibernation:</p>\n<pre><code class=\"language-bash\">sudo mkdir -p /etc/polkit-1/localauthority/10-vendor.d\nsudo nano /etc/polkit-1/localauthority/10-vendor.d/com.ubuntu.hibernate.pkla\n</code></pre>\n<p>Add the following content:</p>\n<pre><code class=\"language-ini\">[Re-enable hibernate for UPower]\nIdentity=unix-user:*\nAction=org.freedesktop.upower.hibernate\nResultActive=yes\n\n[Re-enable hibernate for logind]\nIdentity=unix-user:*\nAction=org.freedesktop.login1.hibernate; \\\n       org.freedesktop.login1.handle-hibernate-key; \\\n       org.freedesktop.login1.hibernate-multiple-sessions; \\\n       org.freedesktop.login1.hibernate-ignore-inhibit\nResultActive=yes\n</code></pre>\n<h3>5. Reboot and Test</h3>\n<p>Reboot your system:</p>\n<pre><code class=\"language-bash\">sudo reboot\n</code></pre>\n<p>Test hibernation:</p>\n<pre><code class=\"language-bash\">sudo systemctl hibernate\n</code></pre>\n<p>Your computer should power off. When you turn it back on, your session should be restored exactly as you left it.</p>\n<h2>Tips and Important Notes</h2>\n<ul>\n<li><strong>Swap file size</strong>: The swap file must be at least as large as your installed RAM to accommodate hibernation.</li>\n<li><strong>GRUB parameters</strong>: An error in the GRUB parameters can prevent the system from booting. Double-check your UUID and offset values.</li>\n<li><strong>Fragmentation</strong>: On some systems, swap file fragmentation can cause issues. It&#39;s best to create a swap file on a partition with little fragmentation.</li>\n<li><strong>Proprietary drivers</strong>: If you use proprietary drivers (e.g., Nvidia), check their compatibility with hibernation.</li>\n<li><strong>Secure Boot</strong>: On some systems, Secure Boot might need to be disabled for hibernation to work properly.</li>\n<li><strong>File system compatibility</strong>: While most modern file systems support swap files, some (like older versions of Btrfs) might have limitations.</li>\n</ul>\n<h2>Troubleshooting</h2>\n<h3>System Doesn&#39;t Resume After Hibernation</h3>\n<ul>\n<li>Verify the UUID and offset values in your GRUB configuration</li>\n<li>Check if your swap file is large enough</li>\n<li>Ensure the swap file is not fragmented</li>\n<li>Check system logs for errors: <code>journalctl -b -1</code></li>\n</ul>\n<h3>Hibernation Option Not Available</h3>\n<ul>\n<li>Verify that the PolicyKit configuration is correct</li>\n<li>Check if your system supports hibernation: <code>cat /sys/power/state</code> should include &quot;disk&quot;</li>\n<li>Ensure the swap file is active: <code>swapon --show</code></li>\n</ul>\n<h3>System Freezes During Resume</h3>\n<ul>\n<li>This might be related to hardware compatibility issues</li>\n<li>Try updating your kernel and firmware</li>\n<li>Check for known issues with your specific hardware</li>\n</ul>\n<h2>Conclusion</h2>\n<p>With this guide, you can enjoy hibernation even on a system without a dedicated swap partition, using a simple swap file. This gives you more flexibility and can extend your laptop&#39;s autonomy when on the move. The swap file approach is particularly useful for systems where you don&#39;t want to repartition the disk or where you need to adjust the swap size frequently.</p>\n<p>Remember that hibernation performance depends on your disk speed - SSDs will provide much faster resume times than traditional hard drives. Happy hibernating!</p>\n",
  "markdown": "\r\n# How to Enable Hibernation with a Swap File on Ubuntu (and Other Modern Linux Distributions)\r\n\r\nHibernation is a powerful feature that allows you to save the complete state of your session (the contents of RAM) to disk and then completely power off your computer. Upon restarting, everything is restored exactly as it was, with no power consumption during the downtime. However, on many recent Linux distributions, hibernation is not enabled by default, especially if you use a swap file instead of a dedicated swap partition. This guide explains, step by step, how to set up hibernation with a swap file, reliably and securely.\r\n\r\n## Why Use a Swap File for Hibernation?\r\n\r\n- **More flexible than a swap partition**: you can resize it easily without repartitioning your disk\r\n- **Ideal for systems installed without a dedicated swap partition**\r\n- **Compatible with most modern file systems**\r\n- **Easier to manage**: can be created, resized, or removed without affecting other partitions\r\n\r\n## Step-by-Step Guide to Configuring Hibernation with a Swap File\r\n\r\n### 1. Check or Create the Swap File\r\n\r\nFirst, check if you already have a swap file and its size:\r\n\r\n```bash\r\nsudo swapon --show\r\n```\r\n\r\nIf you need to turn off an existing swap file (to resize it, for example):\r\n\r\n```bash\r\nsudo swapoff /swap.img\r\n```\r\n\r\nCreate or resize the swap file. It should be at least as large as your installed RAM:\r\n\r\n```bash\r\n# Example: Creating a 16GB swap file\r\nsudo fallocate -l 16G /swap.img\r\nsudo chmod 600 /swap.img\r\nsudo mkswap /swap.img\r\nsudo swapon /swap.img\r\n```\r\n\r\nMake it permanent by adding it to `/etc/fstab`:\r\n\r\n```bash\r\n# Add this line to /etc/fstab\r\n/swap.img none swap sw 0 0\r\n```\r\n\r\n### 2. Get the Partition UUID and Swap Offset\r\n\r\nGet the UUID of the partition containing the swap file:\r\n\r\n```bash\r\nsudo findmnt -no UUID -T /swap.img\r\n```\r\n\r\nFind the physical offset of the swap file (crucial for hibernation):\r\n\r\n```bash\r\nsudo filefrag -v /swap.img | awk '$1==\"0:\" { print $4 }'\r\n```\r\n\r\nThe output will be something like `0:` followed by numbers. Note the number after the colon and before the period (e.g., `32768`).\r\n\r\n### 3. Configure GRUB for Hibernation\r\n\r\nEdit the GRUB configuration file:\r\n\r\n```bash\r\nsudo nano /etc/default/grub\r\n```\r\n\r\nAdd the resume parameters to `GRUB_CMDLINE_LINUX_DEFAULT` (replace with your values):\r\n\r\n```bash\r\nGRUB_CMDLINE_LINUX_DEFAULT=\"quiet splash resume=UUID=YOUR_UUID resume_offset=YOUR_OFFSET\"\r\n```\r\n\r\nUpdate GRUB and the initramfs:\r\n\r\n```bash\r\nsudo update-grub\r\nsudo update-initramfs -u\r\n```\r\n\r\n### 4. Allow Hibernation for All Users\r\n\r\nCreate the PolicyKit file to allow hibernation:\r\n\r\n```bash\r\nsudo mkdir -p /etc/polkit-1/localauthority/10-vendor.d\r\nsudo nano /etc/polkit-1/localauthority/10-vendor.d/com.ubuntu.hibernate.pkla\r\n```\r\n\r\nAdd the following content:\r\n\r\n```ini\r\n[Re-enable hibernate for UPower]\r\nIdentity=unix-user:*\r\nAction=org.freedesktop.upower.hibernate\r\nResultActive=yes\r\n\r\n[Re-enable hibernate for logind]\r\nIdentity=unix-user:*\r\nAction=org.freedesktop.login1.hibernate; \\\r\n       org.freedesktop.login1.handle-hibernate-key; \\\r\n       org.freedesktop.login1.hibernate-multiple-sessions; \\\r\n       org.freedesktop.login1.hibernate-ignore-inhibit\r\nResultActive=yes\r\n```\r\n\r\n### 5. Reboot and Test\r\n\r\nReboot your system:\r\n\r\n```bash\r\nsudo reboot\r\n```\r\n\r\nTest hibernation:\r\n\r\n```bash\r\nsudo systemctl hibernate\r\n```\r\n\r\nYour computer should power off. When you turn it back on, your session should be restored exactly as you left it.\r\n\r\n## Tips and Important Notes\r\n\r\n- **Swap file size**: The swap file must be at least as large as your installed RAM to accommodate hibernation.\r\n- **GRUB parameters**: An error in the GRUB parameters can prevent the system from booting. Double-check your UUID and offset values.\r\n- **Fragmentation**: On some systems, swap file fragmentation can cause issues. It's best to create a swap file on a partition with little fragmentation.\r\n- **Proprietary drivers**: If you use proprietary drivers (e.g., Nvidia), check their compatibility with hibernation.\r\n- **Secure Boot**: On some systems, Secure Boot might need to be disabled for hibernation to work properly.\r\n- **File system compatibility**: While most modern file systems support swap files, some (like older versions of Btrfs) might have limitations.\r\n\r\n## Troubleshooting\r\n\r\n### System Doesn't Resume After Hibernation\r\n\r\n- Verify the UUID and offset values in your GRUB configuration\r\n- Check if your swap file is large enough\r\n- Ensure the swap file is not fragmented\r\n- Check system logs for errors: `journalctl -b -1`\r\n\r\n### Hibernation Option Not Available\r\n\r\n- Verify that the PolicyKit configuration is correct\r\n- Check if your system supports hibernation: `cat /sys/power/state` should include \"disk\"\r\n- Ensure the swap file is active: `swapon --show`\r\n\r\n### System Freezes During Resume\r\n\r\n- This might be related to hardware compatibility issues\r\n- Try updating your kernel and firmware\r\n- Check for known issues with your specific hardware\r\n\r\n## Conclusion\r\n\r\nWith this guide, you can enjoy hibernation even on a system without a dedicated swap partition, using a simple swap file. This gives you more flexibility and can extend your laptop's autonomy when on the move. The swap file approach is particularly useful for systems where you don't want to repartition the disk or where you need to adjust the swap size frequently.\r\n\r\nRemember that hibernation performance depends on your disk speed - SSDs will provide much faster resume times than traditional hard drives. Happy hibernating!\r\n",
  "slug": "hibernate-swap-file"
}